<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-store">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Teacher Panel - Student Attendance Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="assets/js/common.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #f5f6fa;
            min-height: 100vh;
        }

        .main-header {
            background: #1a73e8;
            color: white;
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            font-size: 32px;
            color: white;
        }

        .logo-text {
            font-size: 24px;
            font-weight: bold;
        }

        .logo-text span {
            display: block;
            font-size: 14px;
            opacity: 0.9;
            font-weight: normal;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .welcome-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .welcome-icon {
            font-size: 40px;
            color: #1a73e8;
        }

        .welcome-text h1 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .welcome-text p {
            color: #666;
            font-size: 14px;
        }

        .user-actions {
            display: flex;
            gap: 15px;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .attendance-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            transition: all 0.3s ease;
            border-top: 3px solid #1a73e8;
        }
        
        /* Session type styling */
        .attendance-section.session-lecture {
            border-top-color: #1a73e8;
        }
        
        .attendance-section.session-practical {
            border-top-color: #28a745;
        }
        
        .session-type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: normal;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        .session-type-badge.lecture {
            background-color: #e7f1ff;
            color: #0062cc;
            border: 1px solid #b8daff;
        }
        
        .session-type-badge.practical {
            background-color: #e7f9ed;
            color: #1e7e34;
            border: 1px solid #c3e6cb;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 500;
        }

        select, input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #1a73e8;
        }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .attendance-table th,
        .attendance-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .attendance-table th {
            background: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
        }

        .attendance-table tr:hover {
            background: #f8f9fa;
        }

        .attendance-status {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        /* Updated radio button styles for new structure */
        .attendance-status {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .status-radio {
            position: relative;
            display: inline-block;
            width: 100px;
            height: 40px;
            cursor: pointer;
            margin: 0;
        }
        
        .status-radio-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #f1f1f1;
            border-radius: 20px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 2px solid #e0e0e0;
            overflow: hidden;
        }
        
        /* Add animated background effect */
        .status-radio-slider:after {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        
        input[type="radio"]:checked + .status-radio .status-radio-slider:after,
        input[type="radio"]:checked + label .status-radio-slider:after {
            left: 100%;
        }
        
        input[type="radio"][value="present"]:checked + .status-radio.present .status-radio-slider,
        input[type="radio"][value="present"]:checked + label.present .status-radio-slider {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.5);
            transform: translateY(-2px);
        }
        
        input[type="radio"][value="absent"]:checked + .status-radio.absent .status-radio-slider,
        input[type="radio"][value="absent"]:checked + label.absent .status-radio-slider {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
            box-shadow: 0 0 8px rgba(220, 53, 69, 0.5);
            transform: translateY(-2px);
        }
        
        /* Add scale effect on hover */
        .status-radio .status-radio-slider {
            transform: scale(1);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .status-radio:hover .status-radio-slider {
            transform: scale(1.05);
        }
        
        .status-radio:active .status-radio-slider {
            transform: scale(0.95);
        }
        
        input[type="radio"]:checked + .status-radio:active .status-radio-slider,
        input[type="radio"]:checked + label:active .status-radio-slider {
            transform: scale(0.95);
        }
        
        /* Add icons to buttons */
        .status-radio.present .status-radio-slider:before {
            content: "\f058";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            margin-right: 5px;
            opacity: 0.6;
            transition: all 0.3s ease;
        }
        
        .status-radio.absent .status-radio-slider:before {
            content: "\f057";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            margin-right: 5px;
            opacity: 0.6;
            transition: all 0.3s ease;
        }
        
        /* Hover effects */
        .status-radio.present .status-radio-slider:hover {
            background-color: rgba(40, 167, 69, 0.1);
            border-color: #28a745;
        }
        
        .status-radio.absent .status-radio-slider:hover {
            background-color: rgba(220, 53, 69, 0.1);
            border-color: #dc3545;
        }
        
        input[type="radio"][value="present"]:checked + label.present .status-radio-slider:hover {
            background-color: #218838;
        }
        
        input[type="radio"][value="absent"]:checked + label.absent .status-radio-slider:hover {
            background-color: #c82333;
        }
        
        /* Focus styles for accessibility */
        input[type="radio"]:focus + label .status-radio-slider {
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }

        /* Update hover styles for status radio buttons */
        tbody tr:nth-child(-n+5):nth-child(odd) input[type="radio"]:not(:checked) + label .status-radio-slider {
            background-color: #f8f9fa;
        }

        .btn {
            background: #1a73e8;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background: #1557b0;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Add loading state styles */
        .loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
        }

        .loading .loading-spinner {
            display: block;
        }

        /* Prevent content shift during loading */
        .attendance-section {
            min-height: 400px;
            position: relative;
        }

        /* Smooth transitions */
        .attendance-table {
            transition: opacity 0.3s ease;
        }

        .attendance-table.loading {
            opacity: 0.6;
        }

        /* Cache prevention */
        * {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        /* Stable table layout */
        .attendance-table {
            table-layout: fixed;
            width: 100%;
        }

        /* Prevent layout shifts */
        .attendance-section {
            min-height: 400px;
            position: relative;
            overflow: hidden;
        }

        /* Stable form layout */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
            min-height: 80px; /* Prevent layout shift */
        }

        /* Prevent FOUC */
        .js-loading * {
            visibility: hidden;
        }

        /* Stable radio buttons */
        .attendance-status {
            display: flex;
            gap: 15px;
            min-height: 30px; /* Prevent layout shift */
        }

        .status-radio {
            flex: 1;
            white-space: nowrap;
        }

        /* Prevent text reflow */
        td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Smooth transitions */
        .fade-enter {
            opacity: 0;
        }

        .fade-enter-active {
            opacity: 1;
            transition: opacity 300ms ease-in;
        }

        .fade-exit {
            opacity: 1;
        }

        .fade-exit-active {
            opacity: 0;
            transition: opacity 300ms ease-in;
        }

        /* Alert styles */
        #alertContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            max-width: 400px;
        }

        .alert {
            position: relative;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            line-height: 1.5;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .alert-danger {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .alert-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .alert-dismissible {
            padding-right: 4rem;
        }

        .alert-dismissible .close {
            position: absolute;
            top: 0;
            right: 0;
            padding: 1rem 1.5rem;
            color: inherit;
            background: transparent;
            border: 0;
            cursor: pointer;
            opacity: 0.5;
            font-size: 1.25rem;
        }

        .alert-dismissible .close:hover {
            opacity: 1;
        }

        .error-content {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .error-content i {
            font-size: 1.25rem;
            margin-top: 0.125rem;
        }

        /* Custom styles for duplicate error alerts */
        .alert[style*="background-color: #fff3cd"] {
            padding: 1.25rem;
        }

        .alert[style*="background-color: #fff3cd"] .error-content {
            flex-direction: column;
            gap: 0.5rem;
        }

        .alert[style*="background-color: #fff3cd"] i {
            font-size: 1.5rem;
            color: #856404;
            margin-bottom: 0.25rem;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .logo-section {
                flex-direction: column;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .table {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 8px;
        }

        .table thead th {
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .form-control {
            border-radius: 6px;
            border: 1px solid #ced4da;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-control:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
        }
        
        /* Session type dropdown styling */
        #sessionType {
            font-weight: 500;
            color: #495057;
            background-color: #f8f9fa;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        #sessionType:focus {
            border-color: #4dabf7;
            box-shadow: 0 0 0 0.2rem rgba(38, 143, 255, 0.2);
        }
        
        #sessionType option[value="Lecture"] {
            color: #0062cc;
            font-weight: 500;
        }
        
        #sessionType option[value="Practical"] {
            color: #28a745;
            font-weight: 500;
        }

        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            padding: 0.5rem 1.5rem;
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
        }

        .btn-primary:hover {
            background-color: #0069d9;
            border-color: #0062cc;
            transform: translateY(-1px);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 2rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 0.5rem;
        }

        /* Add pulsing effect for unchecked buttons */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(0, 123, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
        }
        
        /* Only apply pulsing effect to a few rows to improve performance */
        tbody tr:nth-child(-n+5):nth-child(odd) .status-radio input:not(:checked) + .status-radio-slider {
            animation: pulse 2s infinite;
        }
        
        /* Gradient background for buttons */
        .status-radio.present input:checked + .status-radio-slider {
            background: linear-gradient(145deg, #28a745, #218838);
            border-color: #1e7e34;
            color: white;
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
            transform: translateY(-2px);
        }
        
        .status-radio.absent input:checked + .status-radio-slider {
            background: linear-gradient(145deg, #dc3545, #c82333);
            border-color: #bd2130;
            color: white;
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
            transform: translateY(-2px);
        }
        
        /* Change row background when attendance is marked */
        #attendanceTableBody tr.marked {
            background-color: #f8f9fa;
            transition: background-color 0.3s ease;
        }
        
        /* Add a custom checkmark/cross animation */
        .status-radio.present .status-radio-slider:before {
            content: "\f058";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            margin-right: 5px;
            opacity: 0.6;
            transition: all 0.3s ease;
        }
        
        .status-radio.absent .status-radio-slider:before {
            content: "\f057";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            margin-right: 5px;
            opacity: 0.6;
            transition: all 0.3s ease;
        }
        
        .status-radio.present input:checked + .status-radio-slider:before,
        .status-radio.absent input:checked + .status-radio-slider:before {
            opacity: 1;
            transform: scale(1.1);
        }
        
        /* Add a nice touch to the buttons on page load */
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        #attendanceTableBody tr {
            animation: fadeIn 0.5s ease forwards;
            opacity: 0;
        }
        
        /* Limit animation to only the first 10 rows to improve performance */
        #attendanceTableBody tr:nth-child(1) { animation-delay: 0.05s; }
        #attendanceTableBody tr:nth-child(2) { animation-delay: 0.1s; }
        #attendanceTableBody tr:nth-child(3) { animation-delay: 0.15s; }
        #attendanceTableBody tr:nth-child(4) { animation-delay: 0.2s; }
        #attendanceTableBody tr:nth-child(5) { animation-delay: 0.25s; }
        #attendanceTableBody tr:nth-child(6) { animation-delay: 0.3s; }
        #attendanceTableBody tr:nth-child(7) { animation-delay: 0.35s; }
        #attendanceTableBody tr:nth-child(8) { animation-delay: 0.4s; }
        #attendanceTableBody tr:nth-child(9) { animation-delay: 0.45s; }
        #attendanceTableBody tr:nth-child(10) { animation-delay: 0.5s; }
        #attendanceTableBody tr:nth-child(n+11) { 
            animation: none; 
            opacity: 1;
        }
    </style>
</head>
<body class="js-loading">
    <div id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <header class="main-header">
        <div class="header-content">
            <div class="logo-section">
                <i class="fas fa-graduation-cap logo-icon"></i>
                <div class="logo-text">
                    BVIT
                    <span>Attendance Management</span>
                </div>
            </div>
            <div class="user-actions">
                <button onclick="handleLogout()" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="header">
            <div class="welcome-section">
                <i class="fas fa-chalkboard-teacher welcome-icon"></i>
                <div class="welcome-text">
                    <h1>Welcome, <span id="teacherName">Teacher</span></h1>
                    <p id="teacherInfo">Loading teacher information...</p>
                </div>
            </div>
        </div>

        <!-- Add alert container here -->
        <div id="alertContainer"></div>

        <div class="attendance-section">
            <h2>Mark Attendance</h2>
            <div id="errorDisplay" class="error-message" style="display: none; color: #dc3545; margin-bottom: 15px; padding: 10px; border: 1px solid #dc3545; border-radius: 5px; background-color: #ffe6e6;"></div>
            <div id="successDisplay" class="success-message" style="display: none; color: #28a745; margin-bottom: 15px; padding: 10px; border: 1px solid #28a745; border-radius: 5px; background-color: #e6ffe6;"></div>
            <div id="loadingOverlay" class="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 9999;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 10px; color: #666;">Processing...</p>
                </div>
            </div>
            <form id="attendanceForm" onsubmit="handleSubmit(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label for="department">Department:</label>
                        <select id="department" name="department" required>
                            <option value="">Select Department</option>
                            <option value="Computer Engineering">Computer Engineering</option>
                            <option value="Information Technology">Information Technology</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Mechanical">Mechanical</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="class">Class:</label>
                        <select id="class" name="class" required>
                            <option value="">Select Class</option>
                            <option value="First Year">First Year</option>
                            <option value="Second Year">Second Year</option>
                            <option value="Third Year">Third Year</option>
                            <option value="Fourth Year">Fourth Year</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="division">Division:</label>
                        <select id="division" name="division">
                            <option value="">All Divisions</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="subject">Subject:</label>
                        <input type="text" id="subject" name="subject" placeholder="Enter subject name" required>
                    </div>
                    <div class="form-group">
                        <label for="sessionType">Session Type:</label>
                        <select id="sessionType" name="sessionType" required>
                            <option value="Lecture">Lecture</option>
                            <option value="Practical">Practical</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="attendanceDate">Date:</label>
                        <input type="date" id="attendanceDate" name="attendanceDate" required>
                    </div>
                </div>
                <div class="student-list">
                    <div class="attendance-actions" style="margin-bottom: 10px; text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
                        <button type="button" class="btn-secondary" id="clearSelectionBtn" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-eraser"></i> Clear All
                        </button>
                        <button type="button" class="btn-secondary" id="markAllPresentBtn" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-check-circle"></i> Mark All Present
                        </button>
                        <button type="button" class="btn-secondary" id="markAllAbsentBtn" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-times-circle"></i> Mark All Absent
                        </button>
                    </div>
                    <table class="attendance-table">
                        <thead>
                            <tr>
                                <th>Roll No</th>
                                <th>Name</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody">
                            <!-- Students will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <button type="submit" class="btn" id="submitBtn">Mark Attendance</button>
            </form>
        </div>
    </main>

    <script>
        // Global state
        const state = {
            loading: false,
            students: [],
            teacherData: null,
            error: null,
            assignments: null
        };

        // Initialize the page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const token = localStorage.getItem('auth_token');
                const userRole = localStorage.getItem('user_role');
                const userName = localStorage.getItem('user_name');
                
                if (!token || userRole !== 'teacher') {
                    throw new Error('Invalid session');
                }

                // Update initial UI with stored data
                const teacherNameElement = document.getElementById('teacherName');
                const teacherInfoElement = document.getElementById('teacherInfo');
                teacherNameElement.textContent = userName || 'Teacher';

                // Verify token with server
                const response = await fetch('/api/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Invalid session');
                }

                const userData = await response.json();
                console.log('User data:', userData);

                // Update UI with verified data
                teacherNameElement.textContent = userData.name;
                teacherInfoElement.textContent = 'Loading teacher information...';

                // Load teacher data
                await loadTeacherData();
                
                // Add event listeners for department, class, and division selects
                const departmentSelect = document.getElementById('department');
                const classSelect = document.getElementById('class');
                const divisionSelect = document.getElementById('division');
                
                if (departmentSelect) {
                    departmentSelect.addEventListener('change', filterAndDisplayStudents);
                }
                
                if (classSelect) {
                    classSelect.addEventListener('change', filterAndDisplayStudents);
                }
                
                if (divisionSelect) {
                    divisionSelect.addEventListener('change', filterAndDisplayStudents);
                }
                
                // Remove loading state
                document.body.classList.remove('js-loading');
            } catch (error) {
                console.error('Initialization error:', error);
                handleError(error);
                setTimeout(() => {
                    localStorage.clear();
                    window.location.href = '/login.html';
                }, 2000);
            }
        });

        async function loadTeacherData() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';
            
            try {
                console.log('Loading teacher data...');
                const token = localStorage.getItem('auth_token');
                const userId = localStorage.getItem('user_id');
                
                console.log('Auth token:', token ? 'Present' : 'Missing');
                console.log('User ID:', userId);

                if (!token || !userId) {
                    throw new Error('Missing authentication data');
                }

                // Get teacher data
                console.log('Fetching teacher data from /api/auth/me');
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('Teacher data response status:', response.status);
                if (!response.ok) {
                    const text = await response.text();
                    console.error('Teacher data response error:', text);
                    throw new Error('Failed to load teacher data');
                }

                const data = await response.json();
                console.log('Teacher data:', data);
                
                // Store teacher data in localStorage for debugging
                localStorage.setItem('teacher_data', JSON.stringify(data));

                // Update UI with teacher data
                updateTeacherUI(data);

                // Load assigned students
                await loadAssignedStudents(userId);

            } catch (error) {
                console.error('Detailed error loading teacher data:', {
                    message: error.message,
                    stack: error.stack
                });
                showError('Failed to load teacher data: ' + error.message);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        async function loadAssignedStudents(teacherId) {
            try {
                console.log('Loading students for teacher:', teacherId);
                const token = localStorage.getItem('auth_token');
                
                if (!token) {
                    throw new Error('No auth token found');
                }

                const apiUrl = `/api/teacher/${teacherId}/students`;
                console.log('Making request to:', apiUrl);
                
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('Response status:', response.status);
                const responseText = await response.text();
                console.log('Response text length:', responseText.length);
                console.log('Response text preview:', responseText.substring(0, 200) + '...');

                // Parse the response JSON
                let data;
                try {
                    data = JSON.parse(responseText);
                    // Log the full data structure to help debugging
                    console.log('Full response data structure:', JSON.stringify(data));
                } catch (e) {
                    console.error('Error parsing JSON:', e);
                    throw new Error('Invalid response format from server');
                }

                // Check for specific error conditions
                if (response.status === 400) {
                    // Handle specific error cases with helpful messages
                    if (data.message) {
                        if (data.message.includes('No departments or classes assigned')) {
                            showError('You have no departments or classes assigned. Please contact the administrator to set up your teaching assignments.');
                            
                            // Update form with empty data but show fields
                            updateFormWithAssignments({
                                department: [],
                                classes: [],
                                divisions: data.divisions || []
                            });
                            
                            return;
                        } else if (data.message.includes('No departments assigned')) {
                            showError('You have no departments assigned. Please contact the administrator to set up your department assignments.');
                            
                            // Update form with available data
                            updateFormWithAssignments({
                                department: [],
                                classes: data.classes || [],
                                divisions: data.divisions || []
                            });
                            
                            return;
                        } else if (data.message.includes('No classes assigned')) {
                            showError('You have no classes assigned. Please contact the administrator to set up your class assignments.');
                            
                            // Update form with available data
                            updateFormWithAssignments({
                                department: data.department || [],
                                classes: [],
                                divisions: data.divisions || []
                            });
                            
                            return;
                        }
                    }
                    
                    // Generic error for status 400
                    throw new Error(`Bad request: ${data.message || 'Unknown error'}`);
                }

                if (!response.ok) {
                    throw new Error(`Failed to load students: ${response.status} - ${data.message || responseText}`);
                }

                // Check for valid data structure
                if (!data || !data.students || !Array.isArray(data.students)) {
                    console.error('Invalid data structure received:', data);
                    throw new Error('Invalid data structure received from server');
                }

                if (data.students.length === 0) {
                    console.warn('No students assigned to this teacher');
                    showWarning('No students match your department, class, and division criteria. Please check with administrator if this is unexpected.');
                }

                // Update form with teacher's assignments
                updateFormWithAssignments(data);

                // Store students data for later use
                window.assignedStudents = data.students;
                console.log('Stored assigned students array:', window.assignedStudents);
                
                // Pre-select the first department and class if available
                if (data.department && data.department.length > 0 && data.classes && data.classes.length > 0) {
                    const departmentSelect = document.getElementById('department');
                    const classSelect = document.getElementById('class');
                    
                    if (departmentSelect && classSelect) {
                        departmentSelect.value = data.department[0];
                        classSelect.value = data.classes[0];
                        
                        // Trigger student loading based on selected department and class
                        filterAndDisplayStudents();
                    }
                }

            } catch (error) {
                console.error('Detailed error loading students:', {
                    message: error.message,
                    stack: error.stack
                });
                showError('Failed to load assigned students: ' + error.message);
            }
        }

        function updateFormWithAssignments(data) {
            console.log('Updating form with assignments:', data);
            
            // Update department dropdown
            const departmentSelect = document.getElementById('department');
            departmentSelect.innerHTML = '<option value="">Select Department</option>';
            if (data.department && Array.isArray(data.department) && data.department.length > 0) {
                data.department.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    departmentSelect.appendChild(option);
                });
                console.log(`Added ${data.department.length} department options`);
            } else {
                console.warn('No departments found in data:', data);
            }

            // Update class dropdown
            const classSelect = document.getElementById('class');
            classSelect.innerHTML = '<option value="">Select Class</option>';
            if (data.classes && Array.isArray(data.classes) && data.classes.length > 0) {
                data.classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls;
                    option.textContent = cls;
                    classSelect.appendChild(option);
                });
                console.log(`Added ${data.classes.length} class options`);
            } else {
                console.warn('No classes found in data:', data);
            }

            // Update division dropdown if divisions exist
            const divisionSelect = document.getElementById('division');
            divisionSelect.innerHTML = '<option value="">All Divisions</option>';
            if (data.divisions && Array.isArray(data.divisions) && data.divisions.length > 0) {
                data.divisions.forEach(div => {
                    const option = document.createElement('option');
                    option.value = div;
                    option.textContent = div;
                    divisionSelect.appendChild(option);
                });
                console.log(`Added ${data.divisions.length} division options`);
            } else {
                console.log('No divisions specified, showing all divisions');
            }
        }

        function updateTeacherUI(data) {
            const teacherNameElement = document.getElementById('teacherName');
            const teacherInfoElement = document.getElementById('teacherInfo');
            
            if (data) {
                teacherNameElement.textContent = data.name || 'Teacher';
                const info = [];
                if (data.department) info.push(`Department: ${data.department.join(', ')}`);
                if (data.designation) info.push(`Role: ${data.designation}`);
                teacherInfoElement.textContent = info.join(' | ') || 'Teacher Information';
            } else {
                teacherNameElement.textContent = 'Teacher';
                teacherInfoElement.textContent = 'Welcome to the Teacher Panel';
            }
        }

        function populateDepartments(departments) {
            const departmentSelect = document.getElementById('selectedDepartment');
            departmentSelect.innerHTML = '<option value="">Select a department</option>';
            
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentSelect.appendChild(option);
            });
        }

        async function handleDepartmentChange() {
            const departmentSelect = document.getElementById('selectedDepartment');
            const classSelect = document.getElementById('selectedClass');
            const subjectInput = document.getElementById('selectedSubject');
            const selectedDepartment = departmentSelect.value;

            // Reset dependent fields
            classSelect.innerHTML = '<option value="">Select Class</option>';
            subjectInput.value = '';
            clearStudentList();
            
            if (!selectedDepartment) return;

            // Add standard class options
            const classes = ['First Year', 'Second Year', 'Third Year'];
            classes.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classSelect.appendChild(option);
            });
        }

        async function handleClassChange() {
            const departmentSelect = document.getElementById('selectedDepartment');
            const classSelect = document.getElementById('selectedClass');
            const subjectInput = document.getElementById('selectedSubject');
            const selectedDepartment = departmentSelect.value;
            const selectedClass = classSelect.value;

            // Reset subject input and student list
            subjectInput.value = '';
            clearStudentList();

            if (!selectedDepartment || !selectedClass) return;

            // Load students for this department and class
            await loadStudents(selectedDepartment, selectedClass);
        }

        async function loadStudents(department, className) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';
            
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch(`/api/attendance/students?department=${encodeURIComponent(department)}&class=${encodeURIComponent(className)}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load students');
                }

                const students = await response.json();
                displayStudents(students);
            } catch (error) {
                console.error('Error loading students:', error);
                showError('Failed to load students. Please try again.');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        function displayStudents(students) {
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';

            console.log('Displaying students:', students);

            if (!Array.isArray(students) || students.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="3" style="text-align: center;">No students found matching your criteria</td>';
                tbody.appendChild(tr);
                document.getElementById('submitBtn').disabled = true;
                return;
            }

            students.sort((a, b) => {
                // First try to compare as numbers
                const numA = parseInt(a.rollNo);
                const numB = parseInt(b.rollNo);
                if (!isNaN(numA) && !isNaN(numB)) {
                    return numA - numB;
                }
                // Fall back to string comparison
                return a.rollNo.localeCompare(b.rollNo);
            }).forEach(student => {
                const tr = document.createElement('tr');
                
                // Make sure we have a proper ID for the student
                const studentId = student._id || student.id;
                if (!studentId) {
                    console.error('Student missing ID:', student);
                    return; // Skip this student
                }
                
                tr.setAttribute('data-student-id', studentId);
                
                tr.innerHTML = `
                    <td>${student.rollNo || 'N/A'}</td>
                    <td>${student.name || 'Unknown'}</td>
                    <td>
                        <div class="attendance-status">
                            <input type="radio" id="present_${studentId}" name="attendance_${studentId}" value="present" required>
                            <label class="status-radio present" for="present_${studentId}">
                                <span class="status-radio-slider">Present</span>
                            </label>
                            <input type="radio" id="absent_${studentId}" name="attendance_${studentId}" value="absent" required>
                            <label class="status-radio absent" for="absent_${studentId}">
                                <span class="status-radio-slider">Absent</span>
                            </label>
                        </div>
                    </td>
                `;

                // Add click event to the entire row for easier selection
                tr.addEventListener('click', (e) => {
                    // Don't trigger if clicking on the radio buttons directly
                    if (e.target.type === 'radio') return;
                    
                    // Find the first unchecked radio in the row
                    const radios = tr.querySelectorAll('input[type="radio"]');
                    const unchecked = Array.from(radios).find(radio => !radio.checked);
                    if (unchecked) {
                        unchecked.checked = true;
                        // Add the marked class to the row
                        tr.classList.add('marked');
                    } else {
                        // If all are checked, select the first one
                        radios[0].checked = true;
                        // Add the marked class to the row
                        tr.classList.add('marked');
                    }
                });

                // Add change event listeners to radio buttons to update the marked class
                const radios = tr.querySelectorAll('input[type="radio"]');
                radios.forEach(radio => {
                    radio.addEventListener('change', () => {
                        if (radio.checked) {
                            tr.classList.add('marked');
                        }
                    });
                });

                tbody.appendChild(tr);
            });

            // Enable submit button once students are loaded
            document.getElementById('submitBtn').disabled = false;
        }

        function clearStudentList() {
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = '';
            document.getElementById('submitBtn').disabled = true;
        }

        function showError(message) {
            console.error('Error:', message);
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger';
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.left = '50%';
            alertDiv.style.transform = 'translateX(-50%)';
            alertDiv.style.zIndex = '1000';
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-check-circle"></i> ${message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            `;
            alertContainer.appendChild(alert);

            // Remove the alert after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function handleError(error) {
            const teacherNameElement = document.getElementById('teacherName');
            const teacherInfoElement = document.getElementById('teacherInfo');
            
            teacherNameElement.textContent = 'Error';
            teacherInfoElement.textContent = 'Failed to load teacher data. Please try logging in again.';
            
            // Add error styling
            teacherInfoElement.style.color = '#dc3545';
            
            // Show logout button
            const logoutBtn = document.querySelector('.logout-btn');
            if (logoutBtn) {
                logoutBtn.style.display = 'block';
            }
        }

        function handleLogout() {
            localStorage.clear();
            window.location.href = '/login.html';
        }

        // Update the date input max attribute whenever the form is loaded or reset
        function updateDateInput() {
            const dateInput = document.getElementById('attendanceDate');
            if (!dateInput) return;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            // Calculate 30 days ago for the min attribute
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            thirtyDaysAgo.setHours(0, 0, 0, 0);
            const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
            
            // Set max attribute to today and min to 30 days ago
            dateInput.setAttribute('max', todayStr);
            dateInput.setAttribute('min', thirtyDaysAgoStr);
            dateInput.value = todayStr; // Default to today
            
            // Remove readonly attribute to allow selecting different dates
            dateInput.removeAttribute('readonly');
            dateInput.style.backgroundColor = '';
            dateInput.style.cursor = 'pointer';
            
            // Remove the restrictive event listeners
            dateInput.removeEventListener('keydown', function(e) {
                e.preventDefault();
                return false;
            });
            
            dateInput.removeEventListener('input', function(e) {
                e.preventDefault();
                this.value = todayStr;
                return false;
            });
            
            // Change the click handler to show helpful message
            dateInput.onclick = function() {
                showInfo('You can select any date from the past 30 days');
            };
        }

        async function handleSubmit(event) {
            event.preventDefault();
            
            const form = event.target;
            const loadingOverlay = document.getElementById('loadingOverlay');
            const errorDisplay = document.getElementById('errorDisplay');
            const successDisplay = document.getElementById('successDisplay');
            
            if (!loadingOverlay || !errorDisplay || !successDisplay) {
                console.error('Required elements not found');
                alert('An error occurred. Please refresh the page and try again.');
                return;
            }
            
            try {
                // Show loading overlay
                loadingOverlay.style.display = 'flex';
                errorDisplay.style.display = 'none';
                successDisplay.style.display = 'none';

                // Get form data
                const formData = {
                    department: form.department.value,
                    class: form.class.value,
                    division: form.division.value,
                    subject: form.subject.value,
                    sessionType: form.sessionType.value,
                    attendanceDate: form.attendanceDate.value,
                    students: []
                };

                console.log('Form data initial:', formData);

                // Get all student rows
                const studentRows = document.querySelectorAll('#attendanceTableBody tr[data-student-id]');
                console.log('Found student rows:', studentRows.length);
                
                let allMarked = true;
                let unmarkedStudents = [];
                
                if (studentRows.length === 0) {
                    throw new Error('No students found for the selected criteria');
                }
                
                studentRows.forEach(row => {
                    const studentId = row.getAttribute('data-student-id');
                    const studentName = row.querySelector('td:nth-child(2)').textContent;
                    const studentRoll = row.querySelector('td:nth-child(1)').textContent;
                    console.log('Processing student ID:', studentId, 'Name:', studentName, 'Roll:', studentRoll);
                    
                    if (!studentId) {
                        console.error('Row missing student ID:', row);
                        return;
                    }
                    
                    const presentRadio = row.querySelector(`input[type="radio"][name="attendance_${studentId}"][value="present"]:checked`);
                    const absentRadio = row.querySelector(`input[type="radio"][name="attendance_${studentId}"][value="absent"]:checked`);
                    
                    console.log(`Student ${studentId} (${studentName}) status:`, { present: !!presentRadio, absent: !!absentRadio });
                    
                    if (presentRadio || absentRadio) {
                        formData.students.push({
                            student: studentId,
                            status: presentRadio ? 'present' : 'absent'
                        });
                    } else {
                        allMarked = false;
                        unmarkedStudents.push({ id: studentId, name: studentName, roll: studentRoll });
                    }
                });

                console.log('Final form data:', formData);

                // Validate form data
                if (!formData.department || !formData.class || !formData.subject || !formData.sessionType || !formData.attendanceDate) {
                    throw new Error('Please fill in all required fields');
                }

                if (formData.students.length === 0) {
                    throw new Error('Please mark attendance for at least one student');
                }
                
                if (!allMarked) {
                    console.warn('Unmarked students:', unmarkedStudents);
                    const unmarkedList = unmarkedStudents.map(s => `${s.name} (${s.roll})`).join(', ');
                    throw new Error(`Please mark attendance for all students. Unmarked: ${unmarkedList}`);
                }

                console.log('Sending attendance data:', formData);

                // Submit attendance
                const response = await fetch('/api/attendance/mark', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                console.log('Server response:', data);

                if (!response.ok) {
                    // Check if it's a duplicate record error
                    if (response.status === 400 && data.message && data.message.includes('Duplicate attendance')) {
                        const confirmUpdate = confirm(
                            `${data.message}\n\nWould you like to update the existing attendance record?`
                        );
                        
                        if (confirmUpdate) {
                            // Add update flag and resubmit
                            formData.updateExisting = true;
                            console.log('Resubmitting with updateExisting flag:', formData);
                            
                            const updateResponse = await fetch('/api/attendance/mark', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                                },
                                body: JSON.stringify(formData)
                            });

                            const updateData = await updateResponse.json();
                            console.log('Update response:', updateData);
                            
                            if (!updateResponse.ok) {
                                throw new Error(updateData.message || 'Failed to update attendance');
                            }

                            // Show success message for update
                            successDisplay.textContent = `Attendance updated successfully for ${formData.subject} (${formData.sessionType})!`;
                            successDisplay.style.display = 'block';
                            form.reset();
                            
                            // Clear the attendance table
                            document.getElementById('attendanceTableBody').innerHTML = '';
                            return;
                        } else {
                            // User chose not to update
                            loadingOverlay.style.display = 'none';
                            return;
                        }
                    }
                    throw new Error(data.message || 'Failed to mark attendance');
                }

                // Show success message
                successDisplay.textContent = `Attendance marked successfully for ${formData.subject} (${formData.sessionType})!`;
                successDisplay.style.display = 'block';
                form.reset();

                // Clear the attendance table
                document.getElementById('attendanceTableBody').innerHTML = '';

            } catch (error) {
                console.error('Error submitting attendance:', error);
                errorDisplay.textContent = error.message || 'An error occurred while marking attendance';
                errorDisplay.style.display = 'block';
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        // Function to mark all students as present
        function markAllStudentsPresent() {
            const studentRows = document.querySelectorAll('#attendanceTableBody tr[data-student-id]');
            
            if (studentRows.length === 0) {
                showInfo('No students found to mark as present');
                return;
            }
            
            console.log('Marking all students as present...');
            
            studentRows.forEach(row => {
                const studentId = row.getAttribute('data-student-id');
                if (!studentId) return;
                
                // Find the "present" radio button and check it
                const presentRadio = row.querySelector(`input[type="radio"][name="attendance_${studentId}"][value="present"]`);
                if (presentRadio) {
                    presentRadio.checked = true;
                    // Add the marked class to the row
                    row.classList.add('marked');
                }
            });
            
            showSuccess('All students marked as present');
        }
        
        // Function to mark all students as absent
        function markAllStudentsAbsent() {
            const studentRows = document.querySelectorAll('#attendanceTableBody tr[data-student-id]');
            
            if (studentRows.length === 0) {
                showInfo('No students found to mark as absent');
                return;
            }
            
            console.log('Marking all students as absent...');
            
            studentRows.forEach(row => {
                const studentId = row.getAttribute('data-student-id');
                if (!studentId) return;
                
                // Find the "absent" radio button and check it
                const absentRadio = row.querySelector(`input[type="radio"][name="attendance_${studentId}"][value="absent"]`);
                if (absentRadio) {
                    absentRadio.checked = true;
                    // Add the marked class to the row
                    row.classList.add('marked');
                }
            });
            
            showSuccess('All students marked as absent');
        }
        
        // Function to clear all attendance selections
        function clearAllSelections() {
            const studentRows = document.querySelectorAll('#attendanceTableBody tr[data-student-id]');
            
            if (studentRows.length === 0) {
                showInfo('No student records to clear');
                return;
            }
            
            console.log('Clearing all attendance selections...');
            
            studentRows.forEach(row => {
                const studentId = row.getAttribute('data-student-id');
                if (!studentId) return;
                
                // Find all radio buttons and uncheck them
                const radios = row.querySelectorAll(`input[type="radio"][name="attendance_${studentId}"]`);
                radios.forEach(radio => {
                    radio.checked = false;
                });
                
                // Remove the marked class from the row
                row.classList.remove('marked');
            });
            
            showInfo('All selections cleared');
        }
        
        // Initialize date input and form when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize date input
            updateDateInput();
            
            // Add form reset handler
            document.getElementById('attendanceForm').addEventListener('reset', function() {
                // Use setTimeout to ensure it runs after the reset
                setTimeout(updateDateInput, 0);
            });

            // Add session type change handler
            const sessionTypeSelect = document.getElementById('sessionType');
            if (sessionTypeSelect) {
                // Initial update
                updateSessionTypeUI(sessionTypeSelect.value);
                
                // Add change listener
                sessionTypeSelect.addEventListener('change', function() {
                    updateSessionTypeUI(this.value);
                });
            }
            
            // Add event listener for "Mark All Present" button
            const markAllPresentBtn = document.getElementById('markAllPresentBtn');
            if (markAllPresentBtn) {
                markAllPresentBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    markAllStudentsPresent();
                });
            }
            
            // Add event listener for "Mark All Absent" button
            const markAllAbsentBtn = document.getElementById('markAllAbsentBtn');
            if (markAllAbsentBtn) {
                markAllAbsentBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    markAllStudentsAbsent();
                });
            }
            
            // Add event listener for "Clear Selection" button
            const clearSelectionBtn = document.getElementById('clearSelectionBtn');
            if (clearSelectionBtn) {
                clearSelectionBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    clearAllSelections();
                });
            }
        });

        // Update UI based on session type
        function updateSessionTypeUI(sessionType) {
            const container = document.querySelector('.attendance-section');
            if (!container) return;
            
            // Remove existing session type classes
            container.classList.remove('session-lecture', 'session-practical');
            
            // Add appropriate class
            container.classList.add(sessionType === 'Practical' ? 'session-practical' : 'session-lecture');
            
            // Update heading
            const heading = container.querySelector('h2');
            if (heading) {
                heading.innerHTML = `Mark Attendance <span class="session-type-badge ${sessionType.toLowerCase()}">${sessionType}</span>`;
            }
        }

        function showInfo(message) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = 'alert alert-info alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-info-circle"></i> ${message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            `;
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }

        document.getElementById('department').addEventListener('change', function() {
            const selectedDept = this.value;
            const selectedClass = document.getElementById('class').value;
            const selectedDiv = document.getElementById('division').value;
            updateSubjects(selectedDept, selectedClass);
            filterAndDisplayStudents(selectedDept, selectedClass, selectedDiv);
        });

        document.getElementById('class').addEventListener('change', function() {
            const selectedDept = document.getElementById('department').value;
            const selectedClass = this.value;
            const selectedDiv = document.getElementById('division').value;
            updateSubjects(selectedDept, selectedClass);
            filterAndDisplayStudents(selectedDept, selectedClass, selectedDiv);
        });

        document.getElementById('division').addEventListener('change', function() {
            const selectedDept = document.getElementById('department').value;
            const selectedClass = document.getElementById('class').value;
            const selectedDiv = this.value;
            filterAndDisplayStudents(selectedDept, selectedClass, selectedDiv);
        });

        async function updateSubjects(department, className) {
            try {
                const token = localStorage.getItem('auth_token');
                const userId = localStorage.getItem('user_id');
                
                if (!department || !className) {
                    const subjectInput = document.getElementById('subject');
                    subjectInput.value = ''; // Clear the input
                    return;
                }

                // Clear the subject input field
                const subjectInput = document.getElementById('subject');
                subjectInput.value = '';

            } catch (error) {
                console.error('Error loading subjects:', error);
                showError('Failed to load subjects');
            }
        }

        function filterAndDisplayStudents() {
            const selectedDepartment = document.getElementById('department').value;
            const selectedClass = document.getElementById('class').value;
            const selectedDivision = document.getElementById('division').value;
            
            console.log('Filtering with criteria:', { 
                department: selectedDepartment, 
                class: selectedClass, 
                division: selectedDivision 
            });
            
            if (!selectedDepartment || !selectedClass) {
                clearStudentList();
                console.log('Missing required filters');
                return;
            }
            
            if (!window.assignedStudents || !Array.isArray(window.assignedStudents)) {
                showError('No students data available');
                console.log('No window.assignedStudents array available or not an array:', window.assignedStudents);
                return;
            }
            
            console.log('Total assigned students:', window.assignedStudents.length);
            if (window.assignedStudents.length > 0) {
                console.log('First student data structure:', JSON.stringify(window.assignedStudents[0]));
            } else {
                console.log('No students available in the assigned students array');
                showWarning('No students found matching your criteria. Please check with administrator if this is unexpected.');
                return;
            }
            
            // Filter students based on selected criteria
            let filteredStudents = window.assignedStudents.filter(student => {
                // Debug each student in the console
                console.log('Evaluating student:', student.name, student);
                
                // Check if department is an array or string
                let studentDept = [];
                if (Array.isArray(student.department)) {
                    studentDept = student.department;
                } else if (student.department) {
                    studentDept = [student.department];
                }
                const matchesDepartment = studentDept.includes(selectedDepartment);
                console.log(`Student ${student.name} department check:`, studentDept, 'matches:', matchesDepartment);
                
                // Handle class in the same way (could be array or string)
                let studentClass = [];
                if (Array.isArray(student.classes)) {
                    studentClass = student.classes;
                } else if (student.class) {
                    studentClass = [student.class];
                } else if (typeof student.classes === 'string') {
                    studentClass = [student.classes];
                }
                const matchesClass = studentClass.includes(selectedClass);
                console.log(`Student ${student.name} class check:`, studentClass, 'matches:', matchesClass);
                
                // Handle division (optional)
                let matchesDivision = true; // Default to true if no division selected
                if (selectedDivision) {
                    let studentDivision = [];
                    if (Array.isArray(student.divisions)) {
                        studentDivision = student.divisions;
                    } else if (student.division) {
                        studentDivision = [student.division];
                    } else if (typeof student.divisions === 'string') {
                        studentDivision = [student.divisions];
                    }
                    matchesDivision = studentDivision.includes(selectedDivision);
                    console.log(`Student ${student.name} division check:`, studentDivision, 'matches:', matchesDivision);
                }
                
                console.log(`Student ${student.name} final match result: dept=${matchesDepartment}, class=${matchesClass}, div=${matchesDivision}`);
                
                return matchesDepartment && matchesClass && matchesDivision;
            });
            
            console.log(`Filtered ${filteredStudents.length} students from ${window.assignedStudents.length} total`);
            
            // Display the filtered students
            displayStudents(filteredStudents);
        }

        // Add a warning function for less severe notifications
        function showWarning(message) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = 'alert alert-warning alert-dismissible fade show';
            alert.innerHTML = `
                <div class="error-content">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>${message}</div>
                </div>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            `;
            alertContainer.appendChild(alert);

            // Remove the alert after 10 seconds
            setTimeout(() => {
                alert.remove();
            }, 10000);
        }
        
        // Utility function to check data structures and help with debugging
        function debugStudentData() {
            console.log('=== DEBUG STUDENT DATA ===');
            
            if (!window.assignedStudents) {
                console.log('No assigned students array found');
                return;
            }
            
            console.log(`Total students in assignedStudents: ${window.assignedStudents.length}`);
            
            // Show all students data structure
            window.assignedStudents.forEach((student, index) => {
                console.log(`Student ${index + 1}:`);
                console.log(`  ID: ${student._id}`);
                console.log(`  Name: ${student.name}`);
                console.log(`  Roll No: ${student.rollNo}`);
                
                // Log department data structure
                if (student.department) {
                    if (Array.isArray(student.department)) {
                        console.log(`  Department (array): ${student.department.join(', ')}`);
                    } else {
                        console.log(`  Department (string): ${student.department}`);
                    }
                } else {
                    console.log(`  Department: undefined`);
                }
                
                // Log classes data structure
                if (student.classes) {
                    if (Array.isArray(student.classes)) {
                        console.log(`  Classes (array): ${student.classes.join(', ')}`);
                    } else {
                        console.log(`  Classes (string): ${student.classes}`);
                    }
                } else if (student.class) {
                    console.log(`  Class (string): ${student.class}`);
                } else {
                    console.log(`  Classes/Class: undefined`);
                }
                
                // Log divisions data structure
                if (student.divisions) {
                    if (Array.isArray(student.divisions)) {
                        console.log(`  Divisions (array): ${student.divisions.join(', ')}`);
                    } else {
                        console.log(`  Divisions (string): ${student.divisions}`);
                    }
                } else if (student.division) {
                    console.log(`  Division (string): ${student.division}`);
                } else {
                    console.log(`  Divisions/Division: undefined`);
                }
                
                console.log('---');
            });
            
            // Check current teacher
            const teacherData = JSON.parse(localStorage.getItem('teacher_data') || '{}');
            console.log('Current teacher data:');
            console.log(`  ID: ${teacherData._id || 'unknown'}`);
            console.log(`  Name: ${teacherData.name || 'unknown'}`);
            console.log(`  Department: ${JSON.stringify(teacherData.department) || 'unknown'}`);
            console.log(`  Classes: ${JSON.stringify(teacherData.classes) || 'unknown'}`);
            console.log(`  Divisions: ${JSON.stringify(teacherData.divisions) || 'unknown'}`);
            
            console.log('=== END DEBUG INFO ===');
        }
        
        // Add debug button if in development mode
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            document.addEventListener('DOMContentLoaded', function() {
                const container = document.querySelector('.container');
                if (container) {
                    const debugButton = document.createElement('button');
                    debugButton.textContent = 'Debug Student Data';
                    debugButton.className = 'btn btn-secondary mt-3';
                    debugButton.style.marginLeft = '10px';
                    debugButton.onclick = debugStudentData;
                    
                    const submitBtn = document.getElementById('submitBtn');
                    if (submitBtn && submitBtn.parentNode) {
                        submitBtn.parentNode.appendChild(debugButton);
                    } else {
                        container.appendChild(debugButton);
                    }
                }
            });
        }
    </script>
</body>
</html> 